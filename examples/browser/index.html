<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenIM WebSocket Browser Example</title>
  </head>
  <body>
    <h1>OpenIM WebSocket Browser Example</h1>
    <div>
      <button id="connect">Connect</button>
      <button id="disconnect">Disconnect</button>
      <button id="send">Send Message</button>
      <button id="subscribe">Subscribe to Topic</button>
      <button id="subscribe-custom">Subscribe Custom Topic</button>
      <button id="status">Check Status</button>
    </div>
    <div>
      <h3>Connection Status:</h3>
      <div id="status-display">Disconnected</div>
    </div>
    <div>
      <h3>Network Status:</h3>
      <div id="network-status">Online: <span id="network-online">true</span></div>
    </div>
    <div>
      <h3>Messages:</h3>
      <div id="messages"></div>
    </div>

    <script type="module">
      import { OpenIMWebSocket } from "../../dist/openim-websocket.es.js";

      const messagesDiv = document.getElementById("messages");
      const statusDiv = document.getElementById("status-display");
      const networkOnlineSpan = document.getElementById("network-online");

      function addMessage(message) {
        const div = document.createElement("div");
        div.style.marginBottom = "5px";
        div.style.padding = "5px";
        div.style.backgroundColor = "#f0f0f0";
        div.style.borderRadius = "3px";
        div.textContent = `[${new Date().toLocaleTimeString()}] ${JSON.stringify(message, null, 2)}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateStatus(status) {
        statusDiv.textContent = status;
        statusDiv.style.color = status === "Connected" ? "green" : "red";
      }

      function updateNetworkStatus() {
        networkOnlineSpan.textContent = navigator.onLine;
        networkOnlineSpan.style.color = navigator.onLine ? "green" : "red";
      }

      // 初始化网络状态显示
      updateNetworkStatus();
      
      // 监听网络状态变化
      window.addEventListener('online', updateNetworkStatus);
      window.addEventListener('offline', updateNetworkStatus);

      const ws = new OpenIMWebSocket({
        url: "ws://10.0.2.219:38081",
        enableLogging: true, // 启用日志以便调试
        headers: {
          "client-type": "QichengCloudStorePos",
          Appid: "1004",
          ClientId: "1755307876733-fl8tkss4r",
          Timestamp: Date.now().toString(),
          Authorization: "Bearer QC41028bd338c65c8c30b2d0c",
        },
        reconnectInterval: 3000,
        maxReconnectAttempts: 5,
        heartbeatInterval: 10000, // 10秒心跳间隔
        heartbeatTimeout: 1000,  // 1秒心跳超时
        enableNetworkDetection: true, // 启用网络状态检测（浏览器环境下会自动监听网络状态）
      });

      ws.on("open", () => {
        addMessage({ type: "connection", status: "opened" });
        updateStatus("Connecting...");
      });

      ws.on("connected", (data) => {
        addMessage({ type: "connection", status: "authenticated", data });
        updateStatus("Connected");
      });

      ws.on("close", () => {
        addMessage({ type: "connection", status: "closed" });
        updateStatus("Disconnected");
      });

      ws.on("error", (error) => {
        addMessage({ type: "error", error: error.toString() });
        updateStatus("Error");
      });

      ws.on("message", (data) => {
        addMessage({ type: "message", data });
      });

      ws.on("notification", (data) => {
        addMessage({ type: "notification", data });
      });

      // 监听心跳事件
      ws.on("ping", (data) => {
        addMessage({ type: "heartbeat", direction: "ping", data });
      });

      ws.on("pong", (data) => {
        addMessage({ type: "heartbeat", direction: "pong", data });
      });

      document.getElementById("connect").onclick = async () => {
        try {
          updateStatus("Connecting...");
          await ws.connect();
          addMessage({ type: "action", action: "connect", status: "success" });
        } catch (error) {
          addMessage({
            type: "action",
            action: "connect",
            status: "error",
            error: error.toString(),
          });
          updateStatus("Connection Failed");
        }
      };

      document.getElementById("disconnect").onclick = () => {
        ws.disconnect();
        addMessage({ type: "action", action: "disconnect" });
        updateStatus("Disconnected");
      };

      document.getElementById("send").onclick = () => {
        ws.send({
          type: "message",
          message: "Hello from browser!",
          payload: { timestamp: Date.now() },
        });
      };

      document.getElementById("subscribe").onclick = () => {
        ws.send({
          type: "publish",
          payload: {
            message: "Subscribed to test-topic",
            timestamp: Date.now(),
          },
          topic: "order/1/2/3333",
        });
      };

      document.getElementById("subscribe-custom").onclick = () => {
        const topic = window.prompt("请输入要订阅的 topic：", "");
        if (topic && topic.trim()) {
          ws.subscribe(topic.trim());
        }
      };

      document.getElementById("status").onclick = () => {
        const status = ws.getReconnectStatus();
        addMessage({ 
          type: "status", 
          data: {
            reconnectAttempts: status.attempts,
            maxAttempts: status.maxAttempts,
            isReconnectEnabled: status.isReconnect,
            networkOnline: navigator.onLine
          }
        });
      };
    </script>
  </body>
</html>
